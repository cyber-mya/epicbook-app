---
- name: Update and upgrade packages
  apt:
    update_cache: yes
    upgrade: yes

- name: Install base packages
  apt:
    name:
      - nginx
      - git
      - mysql-client
      - curl
      - build-essential
      - ca-certificates
      - gnupg
    state: present
    update_cache: yes

- name: Add NodeSource repository for Node.js 18
  shell: |
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
  args:
    executable: /bin/bash

- name: Install Node.js and npm
  apt:
    name:
      - nodejs
      - npm
    state: present
    update_cache: yes

- name: Ensure npm binary is in /usr/local/bin (fix PATH issue)
  file:
    src: /usr/bin/npm
    dest: /usr/local/bin/npm
    state: link

- name: Verify Node.js installation
  command: node -v
  register: node_version
  changed_when: false

- debug:
    msg: "Node.js version: {{ node_version.stdout }}"

- name: Verify npm installation
  command: npm -v
  register: npm_version
  changed_when: false

- debug:
    msg: "npm version: {{ npm_version.stdout }}"
