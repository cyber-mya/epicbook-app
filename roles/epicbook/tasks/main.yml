# ----------------------------
# Application setup
# ----------------------------
- name: Remove old EpicBook directory
  file:
    path: "{{ app_dir }}"
    state: absent

- name: Clone EpicBook repo
  git:
    repo: "{{ epicbook_repo }}"
    dest: "{{ app_dir }}"
    version: main

# ----------------------------
# Node.js Installation
# ----------------------------
- name: Install prereqs for NodeSource
  apt:
    name:
      - curl
      - apt-transport-https
      - ca-certificates
    state: present
    update_cache: yes

- name: Add NodeSource 18.x repo
  shell: curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
 
- name: Install Node.js and npm
  apt:
    name: nodejs
    state: present
    update_cache: yes

- name: Verify npm installed
  shell: which npm
  register: npm_path
  changed_when: false

- debug:
    msg: "NPM path: {{ npm_path.stdout }}"

# ----------------------------
# Install Node.js dependencies
# ----------------------------
- name: Install Node.js dependencies
  npm:
    path: "{{ app_dir }}"
    production: yes

# ----------------------------
# Environment setup
# ----------------------------
- name: Create environment file
  copy:
    dest: "{{ app_dir }}/.env"
    content: |
      DB_HOST={{ db_host }}
      DB_USER={{ db_username }}
      DB_PASSWORD={{ db_password }}
      DB_NAME={{ db_name }}
      DB_PORT=3306
      NODE_ENV=production
      PORT=8080
  notify: Restart EpicBook Service

- name: Update config.json with all environments
  copy:
    dest: "{{ app_dir }}/config/config.json"
    content: |
      {
        "development": {
          "username": "{{ db_username }}",
          "password": "{{ db_password }}",
          "database": "{{ db_name }}",
          "host": "{{ db_host }}",
          "dialect": "mysql"
        },
        "test": {
          "username": "{{ db_username }}",
          "password": "{{ db_password }}",
          "database": "{{ db_name }}",
          "host": "{{ db_host }}",
          "dialect": "mysql"
        },
        "production": {
          "username": "{{ db_username }}",
          "password": "{{ db_password }}",
          "database": "{{ db_name }}",
