---
# ======================
# 1. Install Node.js + npm
# ======================
- name: Add NodeSource 18.x repository
  shell: curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
  args:
    warn: false

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: yes

# ======================
# 2. Prepare Application Directory
# ======================
- name: Remove old EpicBook directory
  file:
    path: "{{ app_dir }}"
    state: absent

- name: Clone EpicBook repo
  git:
    repo: "{{ epicbook_repo }}"
    dest: "{{ app_dir }}"
    version: main

# ======================
# 3. Install Dependencies
# ======================
- name: Install Node.js dependencies
  npm:
    path: "{{ app_dir }}"
    production: yes

# ======================
# 4. Build the Application
# ======================
- name: Build the React application
  shell: npm run build
  args:
    chdir: "{{ app_dir }}"

# ======================
# 5. Set Up Nginx
# ======================
- name: Install Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes

- name: Copy build files to nginx directory
  copy:
    src: "{{ app_dir }}/build/"
    dest: /var/www/html/
    owner: www-data
    group: www-data
    mode: '0755'
    remote_src: yes

- name: Restart nginx
  service:
    name: nginx
    state: restarted
